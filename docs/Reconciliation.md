# Сверка балансов счетов

При ведении журнала транзакций вручную может образоваться ситуация,
когда баланс на одном из счетов не соответствует действительности
(например, забыли вписать какую-то транзакцию, или неточно вспомнили
суммы). Для сверки балансов предназначена транзакция reconciliate.
Полный синтаксис:

    @ 10/02
    reconciliate /путь/к/счёту [with /корреспондирующий/счёт] [{warning|error}: сообщение]

(части в квадратных скобках необязательны).

При обработке транзакции создаётся одна проводка, дебетующая или
кредитующая сверяемый счёт. Следует иметь ввиду, что дебет/кредит
возможны не для всех счетов. Например, если счёт A1 — кредитовый, его
текущий баланс равен 100р, а транзакция reconciliate сообщает, что
баланс равен 50р — то будет выдана ошибка, т.к. невозможно дебетовать
кредитовый счёт.

Корреспондирующий счёт может быть указан явно, конструкцией `with счёт`.
Если не указан, то корреспондирующий счёт для сверки выбирается по общим
правилам поиска корреспондирующих счетов. При поиске счёта используется
дополнительный атрибут category = “reconciliation”.

В простейшем случае для всех сверок может использоваться один свободный
счёт (например, `account корректировка {category = "reconciliation"};`).
Для более точного учёта можно завести отдельные счета для дебетовых
разниц («деньги откуда-то взялись») и кредитовых («деньги куда-то
делись»). При необходимости можно также вести учёт этих разниц по каждой
валюте отдельно.

В конце строки может быть указана конструкция `warning: сообщение` или
`error: сообщение`. Если указано warning, то, если баланс сверяемого
счёта не равен в точности указанной сумме, будет выдано предупреждение.
Если указано error — будет выдана ошибка и работа будет завершена.
Указывать сообщение необязательно — будет использовано сообщение по
умолчанию.

В сообщении для error/warning можно использовать подстановочные
последовательности:

-   `#account` — при выводе будет заменено на полный путь к сверяемому
    счёту;
-   `#actual` — будет заменено на сумму, которая указана как актуальный
    баланс счёта;
-   `#calculated` — будет заменено на баланс счёта, вычисленный по
    предыдущим транзакциям;
-   `#diff` — будет заменено на разницу `#actual` - `#calculated`.

Сообщение, выводимое по умолчанию (если указано только слово warning или
error), соответствует записи: “On reconciliation: calculated balance of
\#account is \#calculated, but actual balance is \#balance.”.

Примеры:

    @ 10/02
    reconciliate карман 152р

    @ 10/02 сколько-то потратил на трамвай
    reconciliate карман 152р with трамвай

    @ 10/02
    reconciliate карман 152р with корректировка warning: куда-то делось #diff!

Пользовательские сообщения наиболее полезны при использовании сверки в
шаблонах или периодических транзакциях:

    @ 12/01
    periodic проверка_транзита = every 1 month do
      reconciliate транзитный_счёт 0р error: Ненулевой баланс транзитного счёта на начало месяца: #calculated! Проверь незакрытые сделки.
